{% extends "base.html" %}
{% block content %}
<div class="section-title">
    <h2>Your Shopping Cart</h2>
    <p>Review your items and proceed to checkout</p>
</div>

<div class="cart-content">
    {% if cart_items %}
    <form action="{{ url_for('checkout') }}" method="post" id="checkout-form" onsubmit="return validateForm()">
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item">
                <div class="cart-item-info">
                    <input type="checkbox" name="selected_items" value="{{ item.id }}" class="item-checkbox">
                    <h3>{{ item.product.name }}</h3>
                    <p>{{ item.product.description }}</p>
                    <p><strong>Price:</strong> ₱{{ "%.2f"|format(item.product.price) }}</p>
                    <p><strong>Quantity:</strong> {{ item.quantity }}</p>
                    <p><strong>Subtotal:</strong> ₱{{ "%.2f"|format(item.product.price * item.quantity) }}</p>
                </div>
                <div class="cart-item-actions">
                    <button type="button" class="btn btn-outline remove-btn" data-cart-id="{{ item.id }}">Remove</button>
                    <button type="button" class="btn btn-primary checkout-single" data-cart-id="{{ item.id }}">Checkout</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="cart-total">
            <h3 id="selected-total">Total: ₱0.00</h3>
            <div class="delivery-info">
                <h4>Delivery Information</h4>
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" name="name" value="{{ session.get('name', '') }}" required>
                </div>
                <div class="form-group">
                    <label for="address">Delivery Address:</label>
                    <textarea id="address" name="address" rows="3" placeholder="House No., Street, Barangay, Municipality" required pattern=".*\d+.*" title="Please include house number"></textarea>
                </div>
                <div class="form-group">
                    <label for="contact">Contact Number:</label>
                    <input type="tel" id="contact" name="contact" placeholder="09123456789" required pattern="^09\d{9}$" title="Please enter a valid Philippine mobile number (11 digits starting with 09)">
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="checkout-btn">Select Items to Checkout</button>
        </div>
    </form>
    <!-- Hidden remove forms -->
    {% for item in cart_items %}
    <form action="{{ url_for('remove_from_cart', cart_id=item.id) }}" method="post" id="remove-form-{{ item.id }}" style="display:none;"></form>
    {% endfor %}
    {% else %}
    <div class="empty-cart">
        <p>Your cart is empty.</p>
        <a href="{{ url_for('shop') }}" class="btn btn-primary">Continue Shopping</a>
    </div>
    {% endif %}
</div>

<style>
.cart-content {
    max-width: 800px;
    margin: 0 auto;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.cart-item-info {
    display: flex;
    align-items: flex-start;
    gap: 15px;
}

.cart-item-info input[type="checkbox"] {
    margin-top: 5px;
    display: none;
}

.cart-item-info h3 {
    margin-bottom: 10px;
    color: var(--dark-color);
    margin-top: 0;
}

.cart-item-info p {
    margin-bottom: 5px;
    color: var(--text-light);
    margin-top: 0;
}

.cart-item-actions {
    flex-shrink: 0;
    display: flex;
    gap: 10px;
}

.cart-total {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-top: 30px;
}

.cart-total h3 {
    margin-bottom: 20px;
    color: var(--dark-color);
}

.empty-cart {
    text-align: center;
    background: white;
    border-radius: 8px;
    padding: 40px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.empty-cart p {
    margin-bottom: 20px;
    color: var(--text-light);
}



#checkout-btn {
    margin-top: 20px;
}
</style>

<script>
function confirmRemove() {
    return confirm('Are you sure you want to remove this item from your cart?');
}

function validateForm() {
    const nameField = document.getElementById('name');
    const addressField = document.getElementById('address');
    const contactField = document.getElementById('contact');

    if (!nameField.value.trim()) {
        alert('Please enter your full name.');
        nameField.focus();
        return false;
    }

    if (!addressField.value.trim()) {
        alert('Please enter your delivery address.');
        addressField.focus();
        return false;
    }

    if (!contactField.value.trim()) {
        alert('Please enter your contact number.');
        contactField.focus();
        return false;
    }

    // Check if address contains a number (house number)
    if (!/\d/.test(addressField.value)) {
        alert('Please include a house number in your address.');
        addressField.focus();
        return false;
    }

    // Check if contact number is valid Philippine mobile number
    if (!/^09\d{9}$/.test(contactField.value)) {
        alert('Please enter a valid Philippine mobile number (11 digits starting with 09).');
        contactField.focus();
        return false;
    }

    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const selectedTotal = document.getElementById('selected-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const checkoutSingleBtns = document.querySelectorAll('.checkout-single');
    const removeBtns = document.querySelectorAll('.remove-btn');
    let selectionMode = false;

    checkoutBtn.addEventListener('click', function() {
        if (!selectionMode) {
            // Validate required fields before entering selection mode
            const nameField = document.getElementById('name');
            const addressField = document.getElementById('address');
            const contactField = document.getElementById('contact');

            if (!nameField.value.trim()) {
                alert('Please enter your full name.');
                nameField.focus();
                return;
            }

            if (!addressField.value.trim()) {
                alert('Please enter your delivery address.');
                addressField.focus();
                return;
            }

            if (!contactField.value.trim()) {
                alert('Please enter your contact number.');
                contactField.focus();
                return;
            }

            // Check if address contains a number (house number)
            if (!/\d/.test(addressField.value)) {
                alert('Please include a house number in your address.');
                addressField.focus();
                return;
            }

            // Check if contact number is valid Philippine mobile number
            if (!/^09\d{9}$/.test(contactField.value)) {
                alert('Please enter a valid Philippine mobile number (11 digits starting with 09).');
                contactField.focus();
                return;
            }

            // Enter selection mode
            selectionMode = true;
            checkboxes.forEach(checkbox => {
                checkbox.style.display = 'block';
            });
            checkoutBtn.textContent = 'Checkout Selected Items';
            checkoutBtn.type = 'submit';
        }
    });

    checkoutSingleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Validate required fields before individual checkout
            const nameField = document.getElementById('name');
            const addressField = document.getElementById('address');
            const contactField = document.getElementById('contact');

            if (!nameField.value.trim()) {
                alert('Please enter your full name.');
                nameField.focus();
                return;
            }

            if (!addressField.value.trim()) {
                alert('Please enter your delivery address.');
                addressField.focus();
                return;
            }

            if (!contactField.value.trim()) {
                alert('Please enter your contact number.');
                contactField.focus();
                return;
            }

            // Check if address contains a number (house number)
            if (!/\d/.test(addressField.value)) {
                alert('Please include a house number in your address.');
                addressField.focus();
                return;
            }

            // Check if contact number is valid Philippine mobile number
            if (!/^09\d{9}$/.test(contactField.value)) {
                alert('Please enter a valid Philippine mobile number (11 digits starting with 09).');
                contactField.focus();
                return;
            }

            const cartId = this.getAttribute('data-cart-id');
            // Set the selected_items to only this item
            checkboxes.forEach(checkbox => {
                if (checkbox.value === cartId) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            });
            // Submit the form
            document.getElementById('checkout-form').submit();
        });
    });

    removeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirmRemove()) {
                const cartId = this.getAttribute('data-cart-id');
                document.getElementById(`remove-form-${cartId}`).submit();
            }
        });
    });

    function updateTotal() {
        let total = 0;
        let selectedCount = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedCount++;
                const itemDiv = checkbox.closest('.cart-item');
                const subtotalText = itemDiv.querySelector('p:last-of-type').textContent;
                const subtotal = parseFloat(subtotalText.split('₱')[1].replace(',', ''));
                total += subtotal;
            }
        });
        selectedTotal.textContent = `Total: ₱${total.toFixed(2)}`;
        if (selectionMode) {
            checkoutBtn.textContent = selectedCount === 0 ? 'Select items to checkout' : `Checkout ${selectedCount} Selected Item${selectedCount > 1 ? 's' : ''}`;
        }
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTotal);
    });

    updateTotal(); // Initial calculation
});
</script>
{% endblock %}
